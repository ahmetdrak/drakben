# tests/test_pentest_orchestrator.py
"""Tests for Pentest Orchestrator - State Machine & LLM Coordinator."""

from unittest.mock import MagicMock, patch

from core.agent.pentest_orchestrator import (
    PROMPTS,
    PentestContext,
    PentestOrchestrator,
    PentestPhase,
    get_orchestrator,
)


class TestPentestPhase:
    """Tests for PentestPhase enum."""

    def test_phases_exist(self) -> None:
        """Verify all pentest phases exist."""
        assert PentestPhase.IDLE is not None
        assert PentestPhase.TARGET_SET is not None
        assert PentestPhase.RECON is not None
        assert PentestPhase.VULN_SCAN is not None
        assert PentestPhase.EXPLOIT is not None
        assert PentestPhase.POST_EXPLOIT is not None
        assert PentestPhase.REPORTING is not None
        assert PentestPhase.COMPLETE is not None

    def test_phases_count(self) -> None:
        """Ensure expected number of phases."""
        assert len(PentestPhase) == 8


class TestPentestContext:
    """Tests for PentestContext dataclass."""

    def test_default_context(self) -> None:
        """Test default context creation."""
        ctx = PentestContext()
        assert ctx.target is None
        assert ctx.phase == PentestPhase.IDLE
        assert ctx.language == "tr"
        assert ctx.open_ports == []
        assert ctx.services == []
        assert ctx.vulnerabilities == []
        assert ctx.credentials == []
        assert ctx.executed_tools == []

    def test_context_with_target(self) -> None:
        """Test context with custom values."""
        ctx = PentestContext(
            target="192.168.1.1",
            phase=PentestPhase.RECON,
            language="en",
        )
        assert ctx.target == "192.168.1.1"
        assert ctx.phase == PentestPhase.RECON
        assert ctx.language == "en"

    def test_context_mutable_fields(self) -> None:
        """Test that mutable fields are independent."""
        ctx1 = PentestContext()
        ctx2 = PentestContext()
        ctx1.open_ports.append({"port": 80})
        assert ctx2.open_ports == []  # Should not be affected


class TestPrompts:
    """Tests for LLM prompt templates."""

    def test_prompts_exist(self) -> None:
        """Verify all prompt templates exist."""
        assert "analyze_output" in PROMPTS
        assert "chat" in PROMPTS
        assert "suggest_next" in PROMPTS

    def test_prompts_have_placeholders(self) -> None:
        """Check prompts have required placeholders."""
        assert "{target}" in PROMPTS["analyze_output"]
        assert "{phase}" in PROMPTS["analyze_output"]
        assert "{output}" in PROMPTS["analyze_output"]
        assert "{lang}" in PROMPTS["analyze_output"]

        assert "{user_input}" in PROMPTS["chat"]
        assert "{target}" in PROMPTS["chat"]


class TestPentestOrchestrator:
    """Tests for PentestOrchestrator class."""

    def test_orchestrator_creation(self) -> None:
        """Test orchestrator initializes correctly."""
        orchestrator = PentestOrchestrator()
        assert orchestrator.context is not None
        assert orchestrator.context.phase == PentestPhase.IDLE
        assert orchestrator.tools is not None

    def test_orchestrator_with_llm(self) -> None:
        """Test orchestrator with LLM client."""
        mock_llm = MagicMock()
        orchestrator = PentestOrchestrator(llm_client=mock_llm)
        assert orchestrator.llm_client == mock_llm

    def test_set_target(self) -> None:
        """Test setting a target."""
        orchestrator = PentestOrchestrator()
        result = orchestrator.set_target("192.168.1.1")

        assert result["success"] is True
        assert orchestrator.context.target == "192.168.1.1"
        assert orchestrator.context.phase == PentestPhase.TARGET_SET
        assert "192.168.1.1" in result["message"]

    def test_set_target_domain(self) -> None:
        """Test setting a domain target."""
        orchestrator = PentestOrchestrator()
        result = orchestrator.set_target("example.com")

        assert result["success"] is True
        assert orchestrator.context.target == "example.com"

    def test_clear_target(self) -> None:
        """Test clearing target resets state."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")
        orchestrator.context.open_ports.append({"port": 80})

        result = orchestrator.clear_target()

        assert result["success"] is True
        assert orchestrator.context.target is None
        assert orchestrator.context.phase == PentestPhase.IDLE
        assert orchestrator.context.open_ports == []

    def test_advance_phase_from_target_set(self) -> None:
        """Test phase advancement from TARGET_SET."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")

        new_phase = orchestrator.advance_phase()
        assert new_phase == PentestPhase.RECON

    def test_advance_phase_full_cycle(self) -> None:
        """Test full phase advancement cycle."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")

        # TARGET_SET → RECON
        assert orchestrator.advance_phase() == PentestPhase.RECON
        # RECON → VULN_SCAN
        assert orchestrator.advance_phase() == PentestPhase.VULN_SCAN
        # VULN_SCAN → EXPLOIT
        assert orchestrator.advance_phase() == PentestPhase.EXPLOIT
        # EXPLOIT → POST_EXPLOIT
        assert orchestrator.advance_phase() == PentestPhase.POST_EXPLOIT
        # POST_EXPLOIT → REPORTING
        assert orchestrator.advance_phase() == PentestPhase.REPORTING
        # REPORTING → COMPLETE
        assert orchestrator.advance_phase() == PentestPhase.COMPLETE

    def test_idle_does_not_advance(self) -> None:
        """Test IDLE phase doesn't advance without target."""
        orchestrator = PentestOrchestrator()
        new_phase = orchestrator.advance_phase()
        assert new_phase == PentestPhase.IDLE

    def test_language_english(self) -> None:
        """Test English language messages."""
        orchestrator = PentestOrchestrator()
        orchestrator.context.language = "en"
        result = orchestrator.set_target("192.168.1.1")

        assert "Target set:" in result["message"]


class TestOrchestratorToolExecution:
    """Tests for tool execution via orchestrator."""

    def test_execute_tool_no_target(self) -> None:
        """Test tool execution without target."""
        orchestrator = PentestOrchestrator()
        result = orchestrator.execute_tool("nmap")

        # May succeed (tool runs) or fail (no tool) - but we have no target
        # The tool will run against nothing, which is fine for this test
        assert isinstance(result, dict)

    def test_execute_unknown_tool(self) -> None:
        """Test executing unknown tool."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")
        result = orchestrator.execute_tool("unknown_tool_xyz")

        assert result["success"] is False

    @patch("core.tools.tool_registry.ToolRegistry.execute")
    def test_execute_tool_mock(self, mock_execute: MagicMock) -> None:
        """Test tool execution with mocked registry."""
        mock_execute.return_value = {
            "success": True,
            "output": "PORT   STATE SERVICE\n22/tcp open  ssh",
        }

        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")
        result = orchestrator.execute_tool("nmap")

        # Tool should be recorded in history
        assert "nmap" in orchestrator.context.executed_tools or result.get("success") is True


class TestOrchestratorLLMIntegration:
    """Tests for LLM integration."""

    def test_chat_without_llm(self) -> None:
        """Test chat mode without LLM returns fallback."""
        orchestrator = PentestOrchestrator()
        result = orchestrator.chat("Hello")

        assert result is not None
        assert isinstance(result, dict)
        assert "response" in result or "success" in result

    def test_chat_with_mock_llm(self) -> None:
        """Test chat mode with mocked LLM."""
        mock_llm = MagicMock()
        mock_llm.chat.return_value = "I am DRAKBEN, your security assistant."

        orchestrator = PentestOrchestrator(llm_client=mock_llm)
        result = orchestrator.chat("Who are you?")

        assert result is not None

    def test_analyze_output_without_llm(self) -> None:
        """Test output analysis without LLM."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")

        result = orchestrator.analyze_output(
            "PORT   STATE SERVICE\n22/tcp open  ssh",
        )

        assert result is not None
        assert isinstance(result, dict)


class TestOrchestratorStatus:
    """Tests for status and reporting."""

    def test_get_status(self) -> None:
        """Test getting orchestrator status."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")

        status = orchestrator.get_status()

        assert status["target"] == "192.168.1.1"
        assert status["phase"] == "TARGET_SET"
        assert "history" in status  # tools_executed is nested under history

    def test_get_status_findings(self) -> None:
        """Test status includes findings."""
        orchestrator = PentestOrchestrator()
        status = orchestrator.get_status()

        assert "findings" in status
        assert isinstance(status["findings"], dict)


class TestSingletonAccessor:
    """Tests for get_orchestrator singleton."""

    def test_get_orchestrator(self) -> None:
        """Test singleton accessor."""
        orch1 = get_orchestrator()
        orch2 = get_orchestrator()

        # Should return same instance
        assert orch1 is orch2

    def test_get_orchestrator_with_llm(self) -> None:
        """Test singleton with LLM client."""
        mock_llm = MagicMock()
        orch = get_orchestrator(llm_client=mock_llm)

        # LLM should be set
        assert orch is not None


class TestEdgeCases:
    """Tests for edge cases and error handling."""

    def test_set_target_empty_string(self) -> None:
        """Test setting empty target."""
        orchestrator = PentestOrchestrator()
        result = orchestrator.set_target("")

        # Should still work (validation is caller's responsibility)
        assert result["success"] is True

    def test_multiple_target_changes(self) -> None:
        """Test changing target multiple times."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")
        orchestrator.set_target("10.0.0.1")

        assert orchestrator.context.target == "10.0.0.1"

    def test_phase_preserved_on_target_change(self) -> None:
        """Test that changing target resets phase."""
        orchestrator = PentestOrchestrator()
        orchestrator.set_target("192.168.1.1")
        orchestrator.advance_phase()  # Now RECON
        orchestrator.set_target("10.0.0.1")

        # Should reset to TARGET_SET
        assert orchestrator.context.phase == PentestPhase.TARGET_SET
